# #11 뉴스 피드 시스템 설계

홈 페이지 중앙에 지속적으로 업데이트되는 스토리들을 의미.

## 1단계 문제 이해 및 설계 범위 특정

- 어떤 플랫폼을 위한 시스템인가? 모바일?웹?
- 중요한 기능은?
- 뉴스피드에 표시되는 스토리 순서 기준은?
- 사용자가 가질 수 있는 최대 친구 수는?
- 트래픽 규모는?
- 이미지, 비디오 가능여부

## 2단계 개략적 설계안 제시 및 동의 구하기

- 피드발행 : 사용자가 스토리를 포스팅 -> 캐시와 DB에 기록
- 뉴스 피드 생성 : 모든 친구의 포스팅을 시간 흐름 역순으로 모아 만듦

> 뉴스 피드 API

- 피드 발행 API
- 피드 읽기 API

> 피드 발행

- 사용자의 API를 통한 업로드
- 로드밸런서의 트래픽 분산
- 웹서버 : 요청을 내부 서비스로 중계
- 포스팅 저장 서비스 : 새 포스팅 -> DB& 캐시
- 포스팅 전송 서비스 : 새 포스팅을 친구의 뉴스 피드에 푸시. 뉴스 피드 데이터를 캐시에 보관하여 빠르게 읽어가도록 함.
- 알림 서비스 : 친구들에게 새 포스팅이 올라왔음을 알림.

> 뉴스 피드 생성

- 사용자 :  API로 피드를 읽음
- 로드밸런서 : 트래픽 분산
- 웹 서버 : 트래픽을 뉴스 피드 서비스로 보냄
- 뉴스 피드 서비스 : 캐시에서 뉴스 피드를 가져오는 서비스
- 뉴스 피드 캐시 : 뉴스 피드를 렌더링할 때 필요한 피드 ID보관

## 3단계 상세 설계

> 피드 발행 흐름 상세 설계

- 웹 서버 : 클라이언트 통신, 인증, 처리율 제한, 올바른 인증 토큰을 Authorization토큰에 넣기. 포스팅 수 제한 걸기.

- 포스팅 전ㄴ송(팬아웃) 서비스 : 친구인 모든 사용자에게 전달하는 과정.

1. 쓰기 시점에 팬아웃
**장점**
- 실시간으로 갱신되며 친구인 사용자에게 즉시 전송
- 새 포스팅이 기록되는 순간 갱신되므로 뉴스 피드를 읽는 데 드는 시간이 짧아짐.
**단점**
- 친구가 많다면 피드 갱신에 많은 시간이 소요될 가능성. aka 핫키
- 서비스를 자주 이용하지 않는 사용자의 피드도 갱신해야 하므로 자원낭비.

2. 읽기 시점에 팬아웃
**장점**
- 비활성화된 사용자, 서비스에 거의 로그인하지 않는 사용자의 경우 유리. 로그인하기전까지는 컴퓨팅 자원을 소모하지 않음.
- 데이터를 친구 각각에 푸시하는 작업이 필요없으므로 핫키 문제X
**단점**
- 뉴스 피드를 읽는 데 많은 시간이 소요될 수 있음.

> 피드 읽기 흐름 상세 설계

![](https://velog.velcdn.com/images/haron/post/39824297-1d62-41d0-be91-0ae401947076/image.png)

> 캐시 구조 ( 핵심 컴포넌트 )
![](https://velog.velcdn.com/images/haron/post/a8a78905-47fd-4625-9578-49e596ac6abc/image.png)

- 뉴스 피드 : 뉴스 피드 ID
- 콘텐츠 : 포스팅 데이터, 인기 콘텐츠는 따로
- 소셜 그래프 : 사용자 간 관계 정보
- 행동 : 포스팅에 대한 사용자 행동(좋아요, 댓글)
- 횟수 : 좋아요 횟수, 응답 수 등

## 4단계 마무리

 **추가로 다룰만한 주제**
 
 DB..
 - 수직적 규모 확장? 수평적 규모 확장?
 - SQL VS NoSQL
 - 주-부 다중화
 - 복제본에 대한 읽기 연산
 - 일관성 모델
 - 데이터베이스 샤딩

 그외
 - 웹 계층 무상태로 운영
 - 가능한 많은 데이터를 캐싱할 방법
 - 여러 데이터 센터 지원 방법
 - 메세지 큐를 이용한 컴포넌트간 결합도 낮추기
 - 핵심 메트릭(트래픽이 몰리는 시간, 피드 새로고침 시 지연시간 등)에 대한 모니터링


