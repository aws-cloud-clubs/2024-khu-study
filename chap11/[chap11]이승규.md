# 뉴스 피드 시스템 설계

## 1. 문제 이해 및 설계 범위 설정

- 모바일 앱, 웹을 지원해야 함.
- 뉴스 피드 페이지에 새로운 스토리를 올리거나 친구가 올린 스토리를 볼 수 있어야 함.
- 시간 역순으로 표시된다.
- 한 사용자가 가질 수 있는 최대 친구수는 5,000명.
- 트래픽 규모는 매일 최대 천만 명.
- 이미지나 비디오 등 미디어 파일도 포함될 수 있음.

## 2. 개략적 설계안 제시 및 동의 구하기

- 피드 발행: 사용자가 스토리를 발행하면 캐시와 데이터베이스에 기록하고 친구의 뉴스피드에 전송함.
- 뉴스 피드 생성: 모든 친구의 포스팅을 모아 시간 흐름으로 정렬
<img width="585" alt="스크린샷 2024-07-15 오후 4 51 11" src="https://github.com/user-attachments/assets/5e084900-104d-4ebd-a515-fa2ff52f34b9">

## 3. 상세 설계

- 웹 서버: 인증, 클라이언트 통신, 처리율 제한 등 기능을 수행해야 함.
- 포스팅 전송(팬아웃) 서비스
  - 쓰기 시점 팬아웃 모델: 포스팅 완료 시 사용자 캐시에 포스팅을 기록함. 뉴스 피드가 실시간 갱신되지만 친구가 많은 사용자의 경우 친구의 뉴스 피드 갱신에 많은 시간이 소요될 수 있음(핫키 문제).
  - 읽기 시점 패아웃 모델: 핫키 문제가 생기지 않고 비활성화된 사용자가 많을 경우 효율적임. 단점은 읽기 시점에 시간이 오래 걸릴 수 있음.
- 두 시스템을 장접을 모두 취하기 위해 기본은 쓰기 시점 팬아웃 모델을 사용하고, 팔로워가 많은 경우에는 읽기 시점 팬아웃 모델을 적용함.
- 안정 해시(consistent hashing)을 통해 핫키 문제를 해결함.
<img width="686" alt="스크린샷 2024-07-15 오후 5 03 54" src="https://github.com/user-attachments/assets/5bcaa014-1e8b-404b-8c22-034f8c074f89">

- 포스트 발행 -> 그래프 데이터베이스에서 친구 ID 목록 가져오기 -> 친구 정보를 가져와 필터링 -> (친구 목록 + 새 포스팅 ID) 쌍을 메세지 큐에 추가 -> 캐시에 (포스트 ID + 유저 ID) 순서쌍 기록

### 캐시 구조

- 뉴스 피드는 상대적으로 최근 데이터가 접근될 확률이 높으므로 캐시 적중률이 높음. 
<img width="718" alt="스크린샷 2024-07-15 오후 5 29 18" src="https://github.com/user-attachments/assets/09f892b0-5bfe-450b-9f73-893ad243085e">

## 4. 마무리

### 데이터베이스 규모 확장

- 수직적 규모 확장 vs 수평적 규모 확장
- SQL vs NoSQL
- 주-부 다중화
- 복제본에 대한 읽기 연산
- 일관성 모델
- 데이터베이스 샤딩

### 추가 논의 주제

- 웹 계층을 무상태로 운영
- 가능한 한 많은 데이터를 캐시할 방법
- 여러 데이터 센터를 지원할 방법
- 메시지 큐를 이용해 결합도 낮추기
- 핵심 매트릭에 대한 모니터링
