# 알림 시스템 설계

## 1. 문제 이해 및 설계 범위 확정

- 푸시 알림, SMS 메세지, 이메일 알림을 지원해야 함.
- 연성 실시간(soft real-time) 시스템이다.
- iOS, 안드로이드, 랩톱/데스크톱을 지원해야 함.
- 알림은 클라이언트 또는 서버에서 만들 수 있음.
- 사용자가 알림을 받지 않도록 설정할 수 있어야 함.
- 하루 천건 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일 알림을 보낼 수 있어야 함.

## 2. 개략적 설계안 제시 및 동의 구하기

### 알림 유형별 지원 방안

- iOS
  - 알림 제공자: 알림을 만들어 보내는 주체. 단말 토큰(device token), 페이로드(payload)를 이용해 알림을 만든다.
  - APNS: 푸시 알림을 iOS 장치로 보내는 애플의 원격 서비스.
  - iOS 단말: 푸시 알림을 수신하는 사용자 단말.
- 안드로이드
  - iOS와 비슷한 절차로 전송되지만 APNS 대신 FCM(Firebase Cloud Messaging)을 사용.
- SMS 메시지
  - 트윌리오(Twilio), 넥스모(Nexmo)같은 사업자 서비스 이용
- 이메일
  - 회사의 고유 이메일 서비스를 이용하거나 상용 이메일 서비스를 이용

### 연락처 정보 수집 절차

- 알림을 보내려면 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요함. 처음 계정을 등록할 때 수집하여 데이터베이스에 저장.
- 유저 테이블과 장치 테이블을 1 : N 매핑으로 저장.
<img width="780" alt="스크린샷 2024-07-15 오후 3 09 34" src="https://github.com/user-attachments/assets/fe5b0777-113e-4ed2-98d8-3f28545ae3c8">

### 알림 전송 및 수신 절차

- 아키텍처는 알림 시스템을 이용하는 서비스들, 알림 서비스, 알림을 전달하는 제3자 서비스로 구성된다.
<img width="824" alt="스크린샷 2024-07-15 오후 3 11 37" src="https://github.com/user-attachments/assets/60c971c7-dd08-4151-a891-7b93fb3069e5">

- 제3자 서비스는 확장성을 고려하여 설계.
- 이 설계는 다음 문제점을 가진다.
  - 알림 서비스가 하나밖에 없으므로 SPOF(Single-Point-Of-Failure)가 존재함.
  - 데이터베이스, 캐시 등 중요 컴포넌트를 개별적으로 늘릴 방법이 없음.
  - 병목 현상이 발생할 수 있음.
- 개선 방안
  - 데이터베이스와 캐시를 알림 서비스로부터 분리.
  - 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이뤄질 수 있도록 함.
  - 메세지 큐를 사용해 컴포넌트간 강한 결합을 끊음.
<img width="988" alt="스크린샷 2024-07-15 오후 3 17 20" src="https://github.com/user-attachments/assets/54efaadf-ccc6-4f35-a04f-3768560784a6">

## 3. 상세 설계

- 안정성: 데이터 손실 방지, 알림 중복 전송 방지(중복 전송은 100% 방지할 수 없음)
- 추가 매커니즘: 재시도 매커니즘, 전송률 제한, 알림 탬플릿, 알림 설정, 보안, 큐에 보관된 알림에 대한 모니터링
<img width="988" alt="스크린샷 2024-07-15 오후 3 36 44" src="https://github.com/user-attachments/assets/56f782c8-8497-42e8-be46-bd6d0457db92">

### 4. 마무리

- 안정성, 보안, 이벤트 추정 및 모니터링, 사용자 설정 등 기능 추가 가능.
