# #10 알림 시스템 설계

- 알림 시스템(notification system)은 최근 많은 프로그램이 채택한 인기 있는 기능

알림 시스템은 단순히 모바일 푸시 알림에 한정되지 않는다. 알림 시스템은 모바일 푸시 알림, SMS 메세지 그리고 이메일의 세 가지로 분류할 수 있다.


iOS 푸시 알림, 안드로이드 푸시 아림, SMS 메세지 그리고 이메일을 지원하는 알림 시스템의 개략적 설계안을 살펴볼 것이다. 아래와 같은 내용을 다룰 것이다.
- 알림 유형별 지원 방안
- 연락처 정보 수집 절차
- 알림 전송 및 수신 절차

## 알림 유형별 지원 방안

각각의 알림 메커니즘이 어떻게 동작하는지 살펴볼 것이다.

**iOS 푸시 알림**  
iOS에서 푸시 알림을 보내기 위해서는 세 가지 컴포넌트가 필요하다.

![ios단말](https://github.com/user-attachments/assets/3316f2bd-1a80-4ebd-919e-790eb8c4e77d)

- 알림 요청(notification request)을 만들어 애플 푸시 알림 서비스(APNS: Apple Push Notification Service)로 보내는 주체

**알림 요청을 만들려면 다음과 같은 데이터가 필요하다.**

- 단말 토큰(device token)
    - 알림 요청을 보내는 데 필요한 고유 식별자
- 페이로드(payload)
    - 알림 내용을 담은 JSON 딕셔너리(dictionary)

![payload](https://github.com/user-attachments/assets/e34443dd-4121-4b23-bc79-53595f01abfe)

- APNS
    - 애플이 제공하는 원격 서비스
    - 푸시 알림을 iOS 장치로 보내는 역할을 담당
- iOS 단말(iOS device)
    - 푸시 알림을 수신하는 사용자 단말

**안드로이드 푸시 알림**  
안드로이드 푸시 알림도 비슷한 절차로 전송된다. APNS 대신 FCM(Firebase Cloud Messaging)을 사용한다는 점만 다르다.

![안드로이드 푸시 알림](https://github.com/user-attachments/assets/68835af9-0eab-450a-8c84-74e4ad8c1646)

**SMS 메세지**  
SMS 메세지를 보낼 때는 보통 트윌리오(Twilio), 넥스모(Nexmo) 같은 제3사업자의 서비스를 이용한다. 이런 서비스는 대부분 상용 서비스라서 이용 요금을 내야 한다.

![sms 메세지](https://github.com/user-attachments/assets/84ce91ca-e536-4533-bd99-3ba4e69350bd)

**이메일**  
대부분의 회사는 고유 이메일 서버를 구축할 역량은 갖추고 있다. 그럼에도 많은 회사가 상용 이메일 서비스를 이용한다. 그중 유명한 서비스로 센드그리드(Sendgrid), 메일침프(Mailchimp)가 있다. 전송 송공률도 높고, 데이터 분석 서비스도 제공한다.

![email 서비스](https://github.com/user-attachments/assets/4ddf1559-6d0b-4e15-a2d4-6beb85d54fb3)

### 연락처 정보 수집 절차

알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다. 사용자가 우리 앱을 설치하거나 처음으로 계정을 등록하면 API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장한다.

### 알림 전송 및 수신 절차  
개략적인 설계안부터 살펴보고 점차 최적화해 나갈 것이다.  

**각 시스템 컴포넌트에 대한 설명**

![개략적 설계안](https://github.com/user-attachments/assets/fe0a1cc4-0b56-4c37-b9c2-5157a869336e)

**각 시스템 컴포넌트에 대한 설명**

- 1부터 N까지의 서비스
    - 이 서비스 각각은 마이크로서비스(microservice)일 수도 있고, 크론잡(cronjob)일 수도 있고, 분산 시스템 컴포넌트일 수도 있다.
    - 사용자에게 납기일을 알리고자 하는 과금 서비스(billing service), 배송 알림을 보내려는 쇼핑몰 웹사이트 등이 예시
- 알림 시스템(notification system)
    - 알림 전송/수신 처리의 핵심
    - 우선 1개 서버만 사용하는 시스템이라고 가정
    - 이 시스템은 서비스 1~N에 알림 전송을 위한 API를 제공해야 함
    - 제 3자 서비스에 전달할 알림 페이로드(payload)를 만들어 낼 수 있어야 함
- 제 3자 서비스(third party services)
    - 이 서비스들은 사용자에게 알림을 실제로 전달하는 역할
    - 제 3자 서비스와의 통합을 진행할 때 유의할 것은 쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야 하는 확장성(extensibility)
    - 또 하나 고려해야 할 것은, 어떤 서비스는 다른 시장에서는 사용할 수 없을 수도 있다는 점
        - FCM은 중국에서는 사용 불가
        - 중국 시장에서는 제이푸시(Jpush), 푸시와이(PushY) 같은 서비스를 사용
- iOS, 안드로이드, SMS, 이메일 단말
    - 사용자는 자기 단말에서 알림을 수신

**이 설계에 존재하는 몇가지 문제**

- SPOF(Single-Point-Of-Failure)
    - 알림 서비스에 서버가 하나밖에 없다는 것으므로, 그 서버에 장애가 생기면 전체 서비스의 장애로 이루어짐
- 규모 확장성
    - 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘리기 불가
- 성능 병목
    - 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업
    - 모든 것을 한 서버로 처리하면 사용자 트래픽이 많이 몰리는 시간에는 시스템이 과부하 상태에 빠짐

## **개략적 설계안(개선된 버전)**

- 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 설계
- 메세지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 제거

## Step3. 상세 설계

개략적 설계를 진행하면서 알림의 종류, 연락처 정보 수집 절차 그리고 알림 전송/수신 절차에 대해서 살펴봤다. 이제 다음 내용을 자세히 알아볼 것이다.

- 안정성(reliability)
- 추가로 필요한 컴포넌트 및 고려사항: 알림 템플릿, 알림 전송, 전송률 제한, 재시도 메커니즘, 보안, 큐에 보관된 알림에 대한 모니터링과 이벤트 추적 등이 해당
- 개선된 설계안

---

### 안정성

분산 환경에서 운영될 알림 시스템을 설계할 때는 안정성을 확보하기 위한 사항 몇 가지를 고려해야 한다.

**데이터 손실 방지**  
- 알림 전송 시스템의 가장 중요한 요구사항 가운데 하나는 어떤 상황에서도 알림이 소실되면 안된다는 것

알림이 지연되거나 순서가 틀려도 괜찮지만, 사라지면 곤란하다는 것이다. 이 요구사항을 만족하려면 알림 시스템은 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다.

**알림 중복 전송 방지**  
같은 알림이 여러 번 반복되는 것을 완전히 막는 것은 가능하지 않다. 대부분의 경우 알림은 딱 한 번만 전송되지만, 분산 시스템의 특성상 가끔 같은 알림이 중복되어 전송되기도 한다.

알림 중복 전송 빈도를 줄이려면 중복을 탐지하는 메커니즘을 도입하고, 오류를 신중하게 처리해야 한다. 아래는 간단한 중복 방지 로직의 사례다.

- 보내야 할 알림이 도착하면 그 이벤트 ID를 검사하여 이전에 본 적이 있는 이벤트인지 확인. 중복된 이벤트라면 버리고, 그렇지 않으면 알림을 발송

> **중복 전송을 100% 방지하는 것은 불가능하다.**

### 추가로 필요한 컴포넌트 및 고려사항

**알림 템플릿**  
- 인자(parameter)나 스타일, 추적 링크(tracking link)를 조정하기만 하면 사전에 지정한 형식에 맞춰 알람을 만들어 내는 틀

**알림 설정**  
사용자는 많은 알림을 받고 있어서 쉽게 피곤함을 느낀다. 따라서 많은 웹사이트와 앱에서는 사용자가 알림 설정을 상세히 조정할 수 있도록 한다.

**전송률 제한**  
- 사용자에게 너무 많은 알림을 보내지 않도록 하는 한 가지 방법은 **‘한 사용자가 받을 수 있는 알림의 빈도를 제한하는 것’**

**재시도 방법**

- 제 3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 삽입
- 같은 문제가 계속해서 발생하면 개발자에게 통지(alert)

**푸시 알림과 보안**

- iOS와 안드로이드 앱의 경우, 알림 전송 API는 appKey와 appSecret을 사용하여 보안을 유지

**큐 모니터링**

- 알림 시스템을 모니터링 할 때 중요한 메트릭(metric) 하나는 큐에 쌓인 알림의 개수

**이벤트 추적**

- 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요