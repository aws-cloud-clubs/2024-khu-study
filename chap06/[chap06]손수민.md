# Chap 6. 키-값 저장소 설계

**키-값 저장소(key-value store)**
- 키-값 데이터베이스라고도 불리는 비관계형 데이터베이스
- 키는 성능상의 이유로 짧을 수록 좋다
- 값은 문자열, 리스트, 객체 어떠한 것도 상관 없음
- put(key, value): 키-값 쌍을 저장소에 저장
- get(key): 인자로 주어진 키에 매달린 값을 꺼냄

### 문제 이해 및 설계 범위 확정
키-값 저장소 설계
- 키-값 쌍의 크지는 10KB 이하이다.
- 큰 데이터를 저장할 수 있어야 한다.
- 높은 가용성을 제공해야 한다. 따라서 시스템은 설사 장애가 있더라도 빨리 응답해야 한다.
- 높은 규모 확장성을 제공해야 한다. 따라서 트래픽 양에 따라 자동적으로 서버 증설/삭제가 이루어져야 한다.
- 데이터 일관성 수준은 조정이 가능해야 한다.
- 응답 지연시간(latency)이 짧아야 한다.

**단일 서버 키-값 저장소**
빠른 속도를 보장하지만 메모리 한계 발생함. 이를 극복하기 위해 데이터 압축(compression), 자주 쓰이는 데이터만 메모리에 두고 나머지는 디스크에 저장함.

이렇게 개선하여도 서버 한 대로 부족함.

### 분산 키-값 저장소

CAP 정리(Consistency, Availability, Partition Tolerance theorem)
- 일관성(consistency), .가용성(availability), 파티션 감내(partition tolerance)라는 세가지 요구사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리이다. 세 가지 중 두 가지를 만족하느냐에 따라 CP 시스템, AP 시스템, CA 시스템(존재X)으로 분류가 가능하다.

**데이터 파티션**
5장에서 다룬 안정 해시를 이용하여 데이터 파티션을 하면 좋은 점
- 규모 확장 자동화(automatic scaling): 시스템 부하에 따라 서버가 자동으로 추가되거나 삭제되도록 만들 수 있다.
- 다양성(heterogeneity): 각 서버의 용량에 맞게 가상 노드의 수를 조정할 수 있다.

**데이터 다중화**
노픙ㄴ 가용성과 안정성을 확보하기 위해 데이터를 N개 서버에 비동기적으로 다중화함. 여기서 N은 튜닝 가능한 값임.

**데이터 일관성**
정족수 합의 (Quorum Consensus) 프로토콜을 사용하여 읽기/쓰기 연산 모두에 일관성 보장

![image](https://github.com/aws-cloud-clubs/2024-khu-study/assets/56192209/566ed96a-33ab-4dbf-ae18-050963543fc7)

- 중재자(coordinator)는 클라이언트와 노드 사이에서 프락시(proxy) 역할을 한다.
- W + R > N 인 경우에는 강한 일관성이 보장됨

일관성 모델
- 강한 일관성: 모든 읽기 연산은 가장 최근에 갱신된 결과를 반환한다. 다시 말해서 클라이언트는 절대로 낡은(out-of-date) 데이터를 보지 못한다.
- 약한 일관성: 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수있다.
- 결과적 일관성: 약한 일관성의 한 형태로, 갱신 결과가 결국에는 모든 사본에 반영(즉, 동기화)되는 모델이다.

비 일관성 해소 기법: 데이터 버저닝
- 버저닝(versioning): 데이터를 변경할 때마다 해당 데이터의 새로운 버전을 만드는 것. 각 버전의데이터는 변경 불가능(immutable)하다.
- 벡터 시계(vector clock): [서버, 버전]의 순서쌍을 데이터에 매단 것임.

**장애 처리**
장애 감지(failure detection) 기법: multicasting 채널을 구축하여 두 대 이상 서버 A의 장애를 보고해야 실제 장애가 발생했다고 간주함. 하지만 멀티캐스팅은 서버가 많을 때 비효율적이어서 gossip protocol 같은 decentralized failure detection  솔루션을 채택하는 편이다.

장애 해소(failure resolution) 전략
- 일시적 장애 처리
    - 엄격한 정족수
    - 느슨한 정족수
- 영구 장애 처리
    - anti-entropy 프로토콜을 구현하여 사본 동기화

**쓰기 경로**

![image](https://github.com/aws-cloud-clubs/2024-khu-study/assets/56192209/1787462a-81a2-4dc9-bc5e-c071953a68b1)

**읽기 경로**

![image](https://github.com/aws-cloud-clubs/2024-khu-study/assets/56192209/03bd8706-2633-4e50-883d-dd4d62a45533)

