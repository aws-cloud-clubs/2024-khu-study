# #5 안정 해시 설계

## 해시 키 재배치(rehash) 문제

보편적인 해시 함수는 `serverIdx = hash(key) % ${서버 수}`

만약 일부 서버가 죽는 일이 생긴다면 계산한 index값은 달라지게 되고 따라서 엉뚱한 서버에 접속하게 됨.
-> 대규모 캐시미스

이를 해결하고자,,,

## 안정 해시

해시 테이블 크기가 조정될 때 평균적으로 k/n개의 키만 재배치한다. (k: 키의 개수, n: 슬롯 개수)

해시 공간의 양쪽을 구부려 해시 링을 만듦.

> 해시 키

- 모듈로 연산으로 배치하는 것이 아닌 링 위에 키를 배치.
- 키가 접속하는 서버는 시계방향으로 링을 탐색하며 만나는 첫 번째 서버
- 그 결과 서버가 추가/삭제 되는 경우에 키 일부만 재배치가 이루어짐.

**문제**
파티션: 인접한 서버 사이의 해시 공간

- 파티션 크기가 균등하게 유지가 불가능.
- 키의 균등 분포가 어려움.

**해결책**

- 가상 노드(복제) 사용
  - 가상 노드는 실제 노드/서버를 가리킴.
  - 키가 시계방향으로 탐색하다 만나는 최초의 가상 노드가 접속할 서버.
  - 링 위에 한 서버를 향하는 여러 가상 노드가 존재해 균등한 파티션을 구성하게 됨.

## 마치며

안정 해시의 이점

- 서버 추가/삭제 시 재배치되는 키의 수 최소화
- 데이터가 보다 균등하게 분포 -> 수평적 규모확장하기 쉬움
- 핫스팟 문제 줄임.(데이터의 균등 분배)
