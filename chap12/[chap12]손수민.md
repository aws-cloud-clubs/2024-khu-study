# Chap 12. 채팅 시스템 설계

### 1단계: 문제 이해 및 설계 범위 확정

- 응답지연이 낮은 일대일 채팅 기능
- 최대 100명까지 참여할 수 있는 그룹 채팅 기능
- 사용자의 접속상태 표시 기능
- 다양한 단말 지원. 하나의 계정으로 여러 단말에 동시 접속 지원
- 푸시 알림

### 2단계: 개략적 설계안 제시 및 동의 구하기

- 클라이언트들로부터 메시지 수신
    - 폴링: 주기적으로 서버에게 확인함
    - 롱 폴링: 클라이언트는 새 메시지가 반환되거나 타임아웃 될 때까지 연결 유지
    - WebSocket: 서버가 클라이언트에게 비동기(async) 메시지를 보낼 때 가장 널리 사용하는 기술
- 메시지 수신자(recipient) 결정 및 전달
- 수신자가 접속(online) 상태가 아닌 경우에는 접속할 때까지 해당 메시지 보관


**상태 유지 서비스**: 채팅 서비스는 상태 유지가 필요.

**제3자 서비스 연동**: 새 메시지를 받으면 앱이 실행 중이지 않더라고 푸시 알림을 받아야 한다.

**규모 확장성**

**저장소**: 일반적인 데이터는 관계형 데이터베이스에 보관하고 채팅 이력은 키-값 저장소를 사용한다. 키-값 저장소는 지연시간이 낮고, 이미 많은 채팅 시스템이 키-값 저장소를 채택하고 있다.

**데이터 모델**: message_id는 시간 순서대로 정렬이 가능해야 한다.

### 3단계: 상세 설계

**서비스 탐색**

- 클라이언트의 위치, 서버의 용량 등을 기준으로 적합한 채팅 서버 추천

**메시지 흐름**

- 1:1 채팅 메시지 처리 흐름

![image](https://github.com/user-attachments/assets/8744ee18-702a-4af9-93f5-743f983f1d40)

- 여러 단말 사이의 메시지 동기화
    - 수신자 ID가 현재 로그인한 사용자 ID와 같다.
    - 키-값 저장소에 보관된 메시지로서, 그 ID가 cur_max_message_id보다 크다.

- 소규모 그룹 채팅에서의 메시지 흐름
    - 수신잡별로 메시지 동기화 큐를 사용하여 단순하게 처리한다.

**접속상태 표시**

- 로그인
- 로그아웃
- 접속 장애
- 상태 정보의 전송

### 4단계: 마무리

- 채팅 앱을 확장하여 사진이나 비디오 등의 미디어를 지원하도록 하는 방법
- 종단 간 암호화
- 캐시
- 로딩 속도 개선
- 오류 처리

