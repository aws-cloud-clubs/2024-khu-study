# #12 채팅 시스템 설계

## 1단계 문제 이해 및 설계 범위 특정

- 어떤 앱인가? 1:1인가 그룹 채팅인가.
- 모바일 앱 ? 웹 앱?
- 처리할 트래픽 규모는?
- 그룹 채팅의 경우 인원 제한은?
- 중요 기능은 무엇이 있는가? ex. 첨부파일?
- 메세지 길이 제한은?
- 종단 간 암호화 지원여부

**이번 장에서 설계할 채팅 앱**
- 응답지연이 낮은 일대일 채팅
- 최대 100명 그룹채팅
- 사용자의 접속상태 표시 기능
- 다양한 단말 지원. 하나의 계정으로 여러 단말에 동시 접속 지원
- 푸시 알림

## 2단계 개략적 설계안 제시 및 동의 구하기

*클라이언트와 서버의 통신 방법에 대한 기본 지식이 필요

> 폴링

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FAJU6v%2FbtrBst0bAvl%2FzWfVmX1WdnaPoId7FUnDHK%2Fimg.png)
클라이언트 주기적으로 서버에게 새 메세지가 있는지 확인하는 방법.답해줄 메세지가 없다면 자원 낭비..

> 롱 폴링

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FFBkki%2FbtrBst6WDhe%2FFaB5C504UwMuxCkgiTJsBK%2Fimg.png)
요청 후 새 메세지나 타임아웃 될 때까지 연결 유지. 만약 메세지를 받았다면 다시 위 과정을 반복.

**치명적인 약점**
- 메세지를 보내는 클라이언트와 수신하는 클라이언트가 같은 채팅 서버에 접속하게 되지 않을 수도 있다.
 일반적으로 http서버는 무상태 서버이므로 로드밸런싱을 위해 RR알고리즘을 사용한다면 메세지를 받은 서버와 수신할 클라이언트의 롱 폴링 연결을 가지고 있지 않은 서버일 수 있음.
- 서버 입장에서 클라이언트가 연결을 해제했는지 알 방법이 없다.
- 타임아웃이 일어날 때마다 서버에 재연결하므로 여전히 비효율적임..

> 웹소켓

서버가 클라이언트에 비동기 메시지를 보낼때 가장 널리 사용.

동일한 프로토콜이 사용가능. 구현 단순&직관적

연결이 영구적으로 유지되어야 하므로 효율적인 연결 관리 필요

> 무상태 서비스

- 로드밸런서 뒤에 위치
- 로그인/회원가입/사용자 프로파일 등을 처리

> 상태유지 서비스

- 채팅 서비스 (각 클라이언트가 채팅서버와 독립적인 네트워크 연결 유지)

> 저장소

SQL 인가 NoSQL인가?
- 데이터 유형과 읽기/쓰기 연산의 패턴을 바탕으로 결정.

채팅 시스템의 데이터..
1. 사용자 프로파일, 설정, 친구 등의 일반 데이터 -> 안정성 보장하는 RDB
2. 채팅 시스템의 고유 데이터(채팅이력)
-> 키-값 저장소 추천
이유..
- 수평적 규모확장이 쉽다
- 데이터 접근 지연시간이 낮다
- RDB는 데이터 중 롱 테일에 해당하는 부분을 잘 처리하지 못함.
- 많은 안정적인 채팅 시스템이 키-값 저장소를 사용중. EX. 페이스북 메신저, 디스코드

## 3단계 상세 설계

> 서비스 탐색

- 사용자 A로그인 시도
- 로드밸런서가 로그인 요청을 API서버들 가운데 하나로 보냄
- 인증 후 최적의 채팅서버를 찾음.
- 해당 서버와 웹 소켓 연결을 맺음

> 메시지 흐름

- A가 채팅 서버 1로 메세지 전송
- ID생성기로 메세지 ID 결정
- 해당 메세지를 메세지 동기화 큐로 전송
- 키-값 저장소에 보관
- B가 접속중이라면 B의 채팅서버로 전송 or 푸시 알림 서버로 보냄
- 메세지를 B에게 전송. B와 B의 채팅 서버는 웹소켓 연결중.

**그룹 채팅방**

소규모 그룹이라면 메세지 동기화 큐를 이용하여 각 사용자에게 보냄.
- 새로운 매세지는 메세지 큐만 보면 되므로 단순.
- 그룹이 크지 않으면 수신자별로 메세지를 복사하여 큐에 넣으면 되므로 작업 비용이 문제X

> 접속상태 표시

프로필 옆의 접속상태를 나타내는 녹색점을 표현하려면??

1. 사용자 로그인을 통해 웹소켓 연결이 맺어짐. 이때 서버는 A의 상태와 마지막 활성화 시간을 키-값 저장소에 보관
2. 로그아웃 시 저장소에 보관된 상태를 offline으로 바꿈.
3. 만약 접속 장애가 발생한다면.. 간단하게는 오프라인을 그냥 온라인으로 바꾼다. (그러나 짧게 끊어졌다 연결되는 것이 네트워크에서는 흔하므로 지나친 대처일 수 있다) 혹은 박동 검사를 한다.
4. 상태 정보는 별도의 서버를 두고 친구인 사람들이 사용자를 구독하는 구독모델을 사용한다. 친구관계마다 채널을 두어 상태정보 변화를 통지받는다.

## 4단계 마무리

 **추가로 다룰만한 주제**
 - 채팅 앱을 확장하여 미디어를 지원하는 방법 : 압축, 클라우드 저장소, 섬네일 생성 등
 - 종단 간 암호화 : 메시지 발신인과 수신인을 제외하고는 메세지를 볼 수 없도록 하기
 - 캐시 : 이미 읽은 메세지를 캐시에 두어 서버와 주고받는 데이터 양 줄이기
 - 로딩 속도 개선 : 사용자 데이터, 채널을 지역적으로 분산하여 앱로딩 속도 개선(Slack)
 - 오류 처리
 - - 채팅 서버 오류 : 서비스 탐색 기능을 통해 새로운 서버 배정
 - - 메시지 재전송 : 재시도나 큐를 이용해 안정적인 메세지 전송을 보장.