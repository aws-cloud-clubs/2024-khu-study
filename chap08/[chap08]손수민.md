# Chap 8. URL 단축기 설계

### 1단계: 문제 이해 및 설계 범위 확정
- URL 단축
- URL redirection
- 높은 가용성과 규모 확장성, 그리고 장애 감내가 요구됨

### 2단계: 개략적 설계안 제시 및 동의 구하기
**API endpoint**
- 클라이언트는 서버가 제공하는 API 엔트포인트를 통해 서버와 통신함
- RESTful API로 설계

1. URL 단축용 엔드포인트: 단축할 URL을 인자로 실어서 POST 요청 보냄
2. URL 리디렉션용 엔드포인트: 단축 URL에 대해서 HTTP 요청이 오면 원래 URL로 보내주기 위한 용도

**URL redirection**
- 단축 URL을 받은 서버는 그 URL을 원래 URL로 바꾸어서 301 응답의 Location 헤더에 넣어 반환한다.

응답 헤더
- 301 Permanently Moved: 해당 URL에 대한 HTTP 요청의 처리 책임이 영구적으로 Location 헤더에 반환된 URL로 이전되었다는 응답이다.영구적으로 이전되었으므로, 브라우저는 이 응답을 캐시한다.
- 302 Found: 주어딘 URL의 요청이 일시적으로 Location 헤더가 지정하는 URL에 의해 처리되야 한다는 응답이다.

-> 서버의 부하를 줄이는 것이 중요하다면 301, 트래픽 분석이 중요할 때는 302를 사용하여 클릭 발생률이나 발생 위치 추적 가능

**URL 단축 플로**
긴 URL을 해시 값으로 대응시킬 해시 함수 fx를 찾는 것이다.
- 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야 한다.
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다.


### 3단계: 상세 설계
**데이터 모델**

<단축 URL, 원래 URL>의 순서쌍을 관계형 데이터에비이스에 저장
|PK|id|
|------|---|
||shortURL|
||longURL|

**해시 함수**

hashValue: [0-9, a-z, A-Z] 62개

1. 해시 후 충돌 해소

긴 URL을 7글자 문자열로 줄이는 해시 함수가 필요하다.
- CRC32, MD5, SHA-1같이 잘 알려진 함수 이용
- 해시값을 7보다 더 줄이기 위해 그림과 같은 알고리즘을 사용한다.
- 데이터베이스 대신 블룸 필터를 사용하면 성능을 높일 수 있다.

![image](https://github.com/aws-cloud-clubs/2024-khu-study/assets/56192209/cca07dd1-0a22-4f20-a79d-df26581fb65a)


2. base-62 변환

|해시 후 충돌 해소 전략|base-62 변환|
|------|---|
|단축 URL의 길이가 고정됨|단축 URL의 길이가 가변적. ID 값이 커지면 같이 길어짐|
|유일성이 보장되는 ID 생성기 필요 X|유일성이 보장되는 ID 생성기 필요 O|
|충돌이 가능해서 해소 전략 필요|ID의 유일성이 보장된 후에야 적용 가능한 전략이라 충돌은 아예 불가능|
|ID로부터 단축 URL을 계산하는 방식이 아니라서 다음에 쓸 수 있는 URL을 알아내는 것이 불가능|ID가 1씩 증가하는 값이라고 가정하면 다음에 쓸 수 있는 단축 URL이 무엇인지 쉽게 알아낼 수 있어서 보안상 문제가 될 소지가 있음|

**URL 리디렉션 상세 설계**
1. 사용자가 단축 URL을 클릭한다.
2. 로드밸런서가 해당 클릭으로 발생한 요청을 웹 서버에 전달한다.
3. 단축 URL이 이미 캐시에 있는 경우에는 원래 URL을 바로 꺼내서 클라이언트에게 전달한다.
4. 캐시에 해당 단축 URL이 없는 경우에는 데이터베이스에서 꺼낸다.
5. 데이터베이스에서 꺼낸 URL 을 캐시에 넣은 후 사용자에게 반환한다.

### 4단계: 마무리

- 처리율 제한 장치(rate limiter)
- 웹 서버의 규모 확장
- 데이터베이스의 규모 확장
- 데이터 분석 솔루션
- 가용성, 데이터 일관성, 안정성