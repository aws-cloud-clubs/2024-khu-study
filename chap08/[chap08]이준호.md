# #8 URL 단축기 설계

## 1단계 문제 이해 및 설계 범위 특정

- 동작 예제 확인하기
- 트래픽 규모는?
- 단축 URL의 길이는?
- URL 제한사항 (불가능한 문자?)
- URL을 시스템에서 지우거나 갱신할 수 있는가?

**기본적인 기능**

1. URL단축 : 주어진 긴 URL을 훨씬 짧게, 가능한 짧게 줄인다.
2. URL 리디렉션 : 축약된 URL로 HTTP요청이 오면 기존 URL로 안내
3. 높은 가용성과 규모 확장성, 장애 감내

## 2단계 개략적 설계안 제시 및 동의 구하기

> API엔드포인트

1. URL단축용 엔드포인트 : 단축할 URL을 인자로 실어서 POST요청을 보내야 함.
   POST /api/v1/data/shorten

2. URL 리디렉션용 엔드포인트 : 단축URL에 대해 기존 URL로 보내주기 위한 용도의 엔드 포인트.
   GET /api/v1/shortUrl

> URL리디렉션

- 단축 URL을 받은 서버는 상태코드301, 원래URL을 반환해준다.
- 클라이언트는 반환된 원래 URL로 방문한다.

**응답코드**

- 301 : 해당 URL에 대한 HTTP 요청의 처리 책임이 Location 헤더에 반환된 URL에 있다. 따라서 이 응답을 캐시하여 이후에 바로 원래 URL로 요청을 보냄.

- 302: '일시적'으로 Location 헤더에 반환된 URL에 의해 처리되어야 한다.

1. 서버부하를 줄이려면 301
2. 트래픽 분석이 중요하다면 302

> URL단축

해시 함수를 이용하여 긴URL을 해시 값에 대응시킨다.

**해시함수**

- 입력 긴URL값이 다르면 해시값도 달라야 함.
- 계싼된 값은 원래의 긴URL로 복원 가능해야 함.

## 3단계 상세 설계

> 데이터 모델

해시 테이블을 메모리에 두는 것은 비싸고 한계가 있으므로 (단축URL, 원래 URL쌍)으로 저장하는 것이 더 나음.
![](https://velog.velcdn.com/images/minu/post/3215ba1f-ccde-49fb-b106-0643eedd8c7a/image.png)

> 해시 함수

[0-9, a-z,A-Z]문자는 총 62개이므로 요구에 맞는 단축 URL길이를 찾아야 함.

- 간단한 방법은 잘 알려진 해시함수를 이용하는 것.
- 이 길이를 줄이려면 반환된 해시값의 초기 N개의 값만 이용하는 것
  **BUT** 충돌이 생길 가능성이 있다. 따라서 충돌이 발생한다면 충돌이 해소될 때까지 사전에 정한 문자열을 해시값에 덧붙인다.
- DB에 확인하는 과정 -> 오버헤드가 크다.

base-62변환

- 진법 변환을 통해 해시값이 갖는 62개의 문자를 62진법을 이용해나타낸다.

> URL 단축기 상세설계

1. 입력으로 긴 URL을 받는다
2. 해당 URL이 있는지 검사
3. 있다ㅣ면 해당 단축URL 단환
4. 없다면 유일ID생성
5. 62진법 변환 적용 -> 단축URL 만듦
6. DB에 순서쌍 저장후 반환.

> 리디렉션시 로드밸런서의 흐름

1. 단축URL클릭
2. 해당 클릭으로 발생한 요청을 웹서버에 전달
3. 캐시에 단축 URL이 있다면 바로 원래 URL을 전달
4. 없다면 DB에서 꺼냄. 없다면 잘못된 입력
5. 꺼낸 URL 반환

## 4단계 마무리

추가로 논의할만한 사항

- 처리율 제한 장치 : 엄청난 요청이 들어오면 무력화 될 수 있음. IP 주소와 같은 필터링 규칙.
- 웹서버 규모 확장: 이번 설계의 웹은 무상태 계층. -> 자요롭게 증설/삭제 가능
- DB 규모 확장 : 다중화 OR 샤딩
- 데이터 분석 솔루션 : 단축기에 데이터 분석 솔루션을 통합하여 사용자들이 얼마나 클릭했고 언제 주로 클릭하는지에 대한 정보를 알아낼 수 있음.
- 가용성, 데이터 일관성, 안정성 : 대규모 시스템을 잘 운영하기 위해 반드시 필요.
