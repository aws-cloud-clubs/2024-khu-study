# Chap 14. 유튜브 설계

### 1단계: 문제 이해 및 설계 범위 확정

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 안정성
- 지원 클라이언트: 모바일 앱, 웹브라우저, 그리고 스마트 TV

**개략적 규모 추정**
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량 = 5백만 X 10% X 300MB = 150TB
- CDN 비용: 5백만 X 5비디오 X 0.3GB X $0.02 = $150,000

### 2단계: 개략적 설계안 제시 및 동의 구하기

개략적으로 보면 이 시스템은 다음의 세 개 컴포넌트로 구성된다.
1. 단말(Client)
2. CDN: 비디오 저장
3. API 서버

**비디오 업로드 절차**
- 사용자
- 로드밸런서
- API 서버
- 메타데이터 데이터베이스
- 메타데이터 캐시
- 원본 저장소
- 트랜스코딩 서버
- 트랜스코딩 비디오 저장소
- CDN
- 트랜스코딩 완료 큐
- 트랜스코딩 완료 핸들러

![image](https://github.com/user-attachments/assets/bf97782d-f230-4358-8654-61c687ff89bc)

**비디오 스트리밍 절차**

 Streaming protocol: 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법

### 3단계: 상세 설계

**비디오 트랜스코딩**

- 비트레이트가 높은 비디오는 고화질 비디오 + 재생하기 위해 높은 성능의 컴퓨팅 파워가 필요하고, 인터넷 회선 속도도 빨라야 함.

인코딩 포맷
- Container: 비디오 파일, 오디오, 메타데이터를 담는 것. .avi, .mov, .mp4같은 파일 확장자 사용
- Codec: 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축 해제 알고리즘

**유향 비순환 그래프(Directed Acyclic Graph, DAG) 모델**

원본 비디오는 비디오, 오디오, 메타데이터의 세 부부능로 나뉘어 처리된다.
작업은 검사, 비디오 인코딩, 섬네일, 워터파크로 나뉘어 진다.

**비디오 트랜스코딩 아키텍처**

![image](https://github.com/user-attachments/assets/1238d736-eaeb-47ae-affe-b271869b609e)

전처리기
1. 비디오 분할
2. DAG 생성
3. 데이터 캐시

DAG 스케줄러
-  stage로 분할한 다음에 각각을 자원 관리자의 Task queue에 집어넣는다.

자원 관리자
- 자원 배분을 효과적으로 수행하는 역할

작업 서버
- DAG에 정의된 작업 수행. 작업 종류에 따라 적업 서버도 구분하여 관리

임시 저장소
- 비디오/오디오 데이터는 BLOB 저장소에 두는 것이 바람직하여 임시 저장소에 보관한 데이터는 비디오 프로세싱이 완료되면 삭제한다.

인코딩된 비디오
- 인코딩 파이프라인의 최종 결과물

**시스템 최적화**
- 속도 최적화: 비디오 병렬 업로드
- 속도 최적화: 업로드 센터를 사용자 근거리에 지정
- 속도 최적화: 모든 절차를 병렬화
- 안전성 최적화: 미리 사인된 업로드 URL
- 안전성 최적화: 비디오 보호

비용 최적화
- CDN 최적화

오류 처리
- Recoverable error
- Non-recoverable error

### 4단계: 마무리

- API 계층의 규모 확장성 확보 방안
- 데이터베이스 계층의 규모 확장성 확보 방안
- Live streaming
- 비디오 삭제(takedown)