# #14 유튜브 설계

## 1단계 문제 이해 및 설계 범위 특정

- 어떤 기능이 가장 중요한가?
- 어떤 클라이언트를 지원하는가?
- 일간 능동 사용자 수는?
- 사용자가 이 제품에 평균적으로 소비하는 시간은 얼마인가?
- 다국어 지원이 필요한가?
- 비디오 파일 크기에 제한이 있는가?
- 아마존, 구글, MS의 클라우드 서비스를 활용가능한가?

**초점**

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성, 규모 확장성, 안정성
- 지원 클라이언트 : 모바일 앱, 웹브라우저, 스마트TV

**개략적 규모 추정**
- 일간 능동 사용자 : 5백만
- 한 사용자는 하루에 평균 5개의 비디오 시청
- 10%의 사용자는 하루에 1 비디오 업로드
- 비디오 평균 크기는 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량 = 5백만*10%*300MB = 150TB
- CDN비용

**CDN비용**
- 클라우드 CDN을 이용한다면 나가는 데이터 양에 따라 과금
- 아존 클라우드프론트 CDN을 예씨로 100% 트래픽이 미국이라면 1GB당 $0.02의 요금.
- 매일 발생하는 요금은 5백만 * 5비디오 * 0.3GB * $0.02 = $150,000 (매우 큰 비용,,)

## 2단계 개략적 설계안 제시 및 동의 구하기

 클라우드 서비스를 이용가능 하므로 CDN과 BLOB스토리지의 경우 클라우드를 활용할 예정.

 **직접 만들지 않는 이유**
 - 시스템 설계 면접은 밑바닥부터 만드는 것과는 관계X. 주어진 시간안에 적절한 기술을 골라 설계하는 것이 포인트. BLOB를 쓴다는 그 사실이면 충분하지 구현 방법에 대한 상세 설계를 제시하는 것은 지나침.
 - BLOB나 CDN을 만드는 것은 복잡 + 많은 비용.


CND : 비디오는 CDN. 재생 버튼을 누르면 으로부터 스트리밍 시작
API서버 : 비디오 스트리밍을 제외한 모든 요청. 비디오 업로드 URL생성, 메타데이터 DB와 캐시 갱신, 가입 등

> 비디오 업로드 절차

![](https://velog.velcdn.com/images/kyy00n/post/2d5f95ba-def1-48d0-8103-e1a2d1c69e3c/image.png)

다음 a,b 두 프로세스가 병렬적으로 수행되어 업로드
> a. 비디오 업로드
1. 비디오를 원본 저장소에 업로드
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩
3. 트랜스코딩 완료시...아래 두가지를 병렬적으로 처리
    3a. 완료된 비디오를 트랜스코딩 저장소에 업로드

    3b. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣음

        3a.1. 비디오를 CDN에 올린다
        3b.1 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다
        3b.1.a, 3b.1.b 완료 핸들러가 메타데이터 DB와 캐시를 갱신한다.

4. API서버가 단말에 업로드가 끝나 스트리밍 준비되었음을 알린다.


> b. 비디오 메타데이터 갱신. 메타데이터에는 비디오 URL,크기,해상도, 포맷, 사용자 정보가 포함.
- 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 서버에 보냄. 서버는 이 정보로 메타데이터 캐시와 DB를 업데이트.

> 비디오 스트리밍 절차

- 스트리밍 프로토콜은 다양하다
- 프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다.
- 그러므로 서비스의 용례에 맞는 프로토콜을 잘 골라야 한다.

## 3단계 상세 설계

> 비디오 트랜스코딩

비디오 녹화시, 특정 포맷으로 저장되므로 다른 단말과 호환되는 비트레이트(비디오를 구성하는 비트가 얼마나 빨리 처리 되어야 하는가)와 포맷으로 저장되어야 함.
다음의 이유로 중요
- 가공되지 않은 원본 비디오는 저장 공간이 크다.
- 상당수 단말과 브라우저는 특정 비디오포맷만 지원한다. 따라서 하나의 비디오를 여러 포맷으로 인코딩해 두는 것이 바람직.
- 사용자에게 끊김없는 고화질 비디오 재생을 보장하기 위해 사용자의 네트워크 상태에 따라, 저화질/고화질 비디오를 보내는 것이 바람직.
- 모바일 단말은 네트워크 상황이 수시로 달라질 수 있으므로 끊김없이 비디오가 재생되기 위해서는 비디오 화질을 자동/수동으로 변경할 수 있도록 하는 것이 바람직.

인코딩 포맷은 다양하지만 대부분은 아래의 두 부분으로 구성되어 있음.
- 컨테이너 : 비디오 파일, 오디오, 메타데이터를 담는 바구니 같은 것
- 코덱 : 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축 해제 알고리즘

> 유향 비순환 그래프(DAG) 모델

- 트랜스코딩에 시간/자원 소모가 큼.
- 창작자마다 새로운 프로세싱 요구사항이 있음.

![] (https://velog.velcdn.com/images/kyy00n/post/4fe2134e-faab-49e0-8519-7f6bcb90cbd7/image.png)

> 비디오 트랜스코딩 아키텍쳐

![](https://velog.velcdn.com/images/kyy00n/post/9861823b-e543-4e4f-8659-b95a1a88887a/image.png)

- 전처리기 : 
1. 비디오 분할 : 비디오 스트림을 GOP단위로 쪼갬.
2. DAG 생성 : 클라이언트 프로그래마가 작성한 설정 파일에 따라 생성.
3. 데이터 캐시 : 전처리기는 분할된 비디오의 캐시. 안정성을 높이기 위해 GOP와 메타데이터를 임시 저장소에 보관

- DAG 스케줄러 : DAG그래프를 몇 개 단계로 분할하여 각각을 자원 관리자의 작업 큐에 집어넣음.

- 자원 관리자 : 자원 배분을 효과적으로 수행
1. 작업 큐 : 실행할 작업이보관되어 있는 우선순위 큐
2. 작업 서버 큐 : 작업 서버의 가용 상태 정보가 보관된 우선순위 큐
3. 실행 큐: 현재 실행 중인 작업 및 서버 정보가 보관된 큐
4. 작업 스케줄러 : 최적의 작업/서버 조합을 골라 작업 지시.

- 작업 서버 :  DAG에 정의된 작업을 수행 작업 종류에 따라 작업 서버도 구분하여 관리

- 임시 저장소 :  여러 저장소 시스템으로 구현 가능. 저장할 데이터 유형, 크기, 이용 빈도, 데이터 유효기간 등에 따라 달라짐. 비디오/오디오 데이터는 BLOB저장소에 두는 것이 바람직.

> 시스템 최적화

속도 최적화
- 비디오 병렬 업로드
- 업로드 센터를 사용자 근거리에 지정 (CDN업로드 센터)
- 모든 절차를 병렬화 (메세지큐)

안정성 최적화
- 미리 사인된 업로드 URL
- 비디오 보호 (DRM, AES암호화, 워터마크)

비용 최적화
- 인기비디오는 CDN으로, 나머지는 비디오 서버
- 짧은 비디오는 필요할 때 인코딩
- 특정 지역에서만 인기가 있다면 다른 지역에 옮기지 않기
- CDN을 직접 구축하고 ISP와 제휴

오류 처리
- 회복 가능 오류 : 세그먼트 트랜스코딩 실패라거나,,
- 회복 불가능 오류 : 비디오 포맷이 잘못 되었다거나,,


## 4단계 마무리

**추가로 논의할 만한 사항**
- API 계층의 규모 확장성 확보 방안 : 현재는 무상태 서버이므로 수평적 규모확장이 가능함
- 데이터베이스 계층의 규모 확장성 확보 방안 : 데이터베이스의 다중화와 샤딩 방법을 통해 가능
- 라이브 스트리밍 : 비디오를 실시간으로 녹화하고 방송하는 절차. 라이브라면 응답지연이 더 낮아야 함. 즉, 스트리밍 프로토콜 선정에 유의해야 함. 작은 단위의 데이터를 실시간으로 빨리 처리해야 하므로 병렬화 필요성은 떨어짐. 마지막으로 오류 처리 방법도 달리해야 함(시간이 오래걸리면 안됨)
- 비디오 삭제: 저작권을 위반, 불법, 선정적인 비디오는 내려야 함. 업로드 과정이나 사용자 신고를 통해 판별.