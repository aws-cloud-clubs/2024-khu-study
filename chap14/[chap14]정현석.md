# #14 유튜브 설계

## Step1. 문제 이해 및 설계 범위 확정
- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용(infrastructure cost)
- 높은 가용성과 규모 확장성 그리고 안전성
- 지원 클라이언트: 모바일 앱, 웹 브라우저 그리고 스마트 TV

### 개략적 규모 추정

다음 추정치들은 많은 것을 가정한 결과다. 면접장에서는 면접관에게 우리가 가정한 사항들을 알리고 동의를 구하자.

- 일간 능동 사용자(DAU: Daily Active User) 수는 5백만(5million)
- 한 사용자는 하루에 평균 5개의 비디오를 시청
- 10%의 사용자가 하루에 1비디오 업로드
- 비디오 평균 크기는 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량 = 5백만 * 10% * 300MB = 150TB
- CDN 비용

## Step2. 개략적 설계안 제시 및 동의 구하기
여기서 제시하는 설계안은 CDN과 BLOB 스토리지의 경우에는 기존 클라우드 서비스를 활용할 것이다.   
다음과 같은 이유들로 직접 만들지 않는다.

- 시스템 설계 면접은 모든 것을 밑바닥부터 만드는 것과는 관계가 없다. 주어진 시간 안에 적절한 기술을 골라 설계를 마치는 것이, 그 기술 각각이 어떻게 동작하는지 상세히 설명하는 것보다 중요하다.
- 규모 확장이 쉬운 BLOB 저장소나 CDN을 만드는 것은 복잡할 뿐 아니라 많은 비용이 소모된다. 넷플릭스나 페이스북 같은 큰 회사도 모든 것을 스스로 구축하지 않는다.

![개략적인 시스템 컴포넌트 구성](https://github.com/user-attachments/assets/dc67c0e0-8d65-4332-90a5-c19b44da93dc)

- 단말(client)
    - 컴퓨터, 모바일 폰, 스마트 TV를 통해서 유튜브를 시청 가능
- CDN
    - 비디오는 CDN에 저장
    - 재생 버튼을 누르면 CDN으로부터 스트리밍이 이루어짐
- API 서버
    - 비디오 스트리밍을 제외한 모든 요청은 API 서버가 처리
    - 피드 추천, 비디오 업로드 URL 생성, 메타데이터 데이터베이스와 캐시 갱신, 사용자 가입 등이 API 서버가 처리하는 작업들

면접관이 아래의 두 영역을 설계해 줄 것을 요청하였다고 가정하자.
- 비디오 업로드 절차
- 비디오 스트리밍 절차


### 비디오 업로드 절차

![비디오 업로드 개략적 설계안](https://github.com/user-attachments/assets/39f701d8-22eb-47e4-82e7-f40bd8e17d32)

**이 설계안의 구성된 컴포넌트들**

- 사용자
    - 컴퓨터나 모바일 폰, 혹은 스마트 TV를 통해 유튜브를 시청하는 이용자
- 로드밸런서(load balancer)
    - API 서버 각각으로 고르게 요청을 분산하는 역할을 담당
- API 서버
    - 비디오 스트리밍을 제외한 다른 모든 요청을 처리
- 메타데이터 데이터베이스(metadata DB)
    - 비디오의 메타데이터를 보관
    - 샤딩(sharding)과 다중화(replication)를 적용하여 성능 및 가용성 요구사항을 충족
- 메타데이터 캐시(metadata cache)
    - 성능을 높이기 위해 비디오 메타데이터와 사용자 객체(user object)는 캐시
- 원본 저장소(original storage)
    - 원본 비디오를 보관할 대형 이진 파일 저장소(BLOB, Binary Large Object Storage) 시스템
    - BLOB 저장소는 “이진 데이터를 하나의 개체로 보관하는 데이터베이스 관리 시스템”
- 트랜스코딩 서버(transcoding server)
    - 비디오 트랜스코딩은 비디오 인코딩이라 부르기도 하는 절차
    - 비디오의 포맷(MPEG, HLS 등)을 변환하는 절차
    - 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기위해 필요
- 트랜스코딩 비디오 저장소(transcoded storage)
    - 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
- CDN
    - 비디오를 캐시하는 역할을 담당
    - 사용자가 재생 버튼을 누르면 비디오 스트리밍은 CDN을 통해 동작
- 트랜스코딩 완료 큐(completion queue)
    - 비디오 트랜스코딩 완료 이벤트들을 보관할 메세지 큐
- 트랜스코딩 완료 핸들러(completion handler)
    - 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들

비디오 업로드는 다음의 **두 프로세스가 병렬적으로 수행**된다.
1. 비디오 업로드
2. 비디오 메타데이터 갱신

> 📖 **비디오 스트리밍에서의 다운로드와 스트리밍**  
**다운로드**: 비디오를 단말로 내려 받는 것  
**스트리밍**: 우리 장치가 원격지의 비디오로부터 지속적으로 비디오 스트림을 전송 받아 영상을 재생하는 것

**널리 사용되는 스트리밍 프로토콜들**

- MPEG-DASH
- 애플(Apple) HLS
- 마이크로소프트 스무드 스트리밍(Microsoft Smooth Streaming)
- 어도비 HTTP 동적 스트리밍(Adobe HTTP Dynamic Streaming, HDS)

## Step3. 상세 설계

### 비디오 트랜스코딩

> 📖 **비트레이트**
비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지를 나타내는 단위

- 비트레이트가 높은 비디오는 일반적으로 고화질 비디오

**비디오 트랜스코딩이 중요한 이유들**

- 가공되지 않은 원본 비디오(raw video)는 저장 공간을 많이 차지
- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원
- 사용자에게 끊김 없는 고화질 비디오 재생을 보장하기 위한 방법
- 이동 통신인 모바일 단말의 경우 네트워크 상황이 수시로 달라지므로, 비디오가 끊김 없이 재생되도록 하기 위해서는 비디오 화질을 자동으로 변경하거나 수동으로 변경할 수 있도록 설정

인코딩 포맷은 다양하지만, 대부분은 다음 두 부분으로 구성되어 있다.

- 컨테이너(container)
- 코덱(codec)

### 유향 비순환 그래프(DAG) 모델

- 비디오를 트랜스코딩하는 것은 컴퓨팅 자원을 많이 소모할 뿐 아니라 시간도 많이 드는 작업


### 비디오 트랜스코딩 아키텍처

![비디오 트랜스코딩 아키텍쳐](https://github.com/user-attachments/assets/1a265ad9-6670-4db7-b29a-9c1b54047123)

**전처리기**  
전처리기가 하는 일은 다음의 세 가지다.

1. 비디오 분할(video splitting)
2. DAG 생성
3. 데이터 캐시

**DAG 스케줄러**  
DAG 스케줄러는 DAG 그래프를 몇 개 단계(stage)로 분할한 다음에 그 각각을 자원 관리자의 작업 큐(task queue)에 집어넣는다.

**자원 관리자(resource manage)**

- 자원 배분을 효과적으로 수행하는 역학을 담당

**작업 서버**

- 작업 서버는 DAG에 정의된 작업을 수행

**임시 저장소**  
임시 저장소 구현시, 여러 저장소 시스템을 활용할 수 있다. 어떤 시스템을 선택할 것이냐는 저장할 데이터의 유형, 크기, 이용 빈도, 데이터 유효기간 등에 따라 달라진다.  
임시 저장소에 보관한 데이터는 비디오 프로세싱이 완료되면 삭제한다.

**인코딩된 비디오**

- 인코딩된 비디오는 인코딩 파이프라인의 최종 결과물


### 시스템 최적화
1. **속도 최적화: 비디오 병렬 업로드**
2. **속도 최적화: 업로드 센터를 사용자 근거리에 지정**
3. **속도 최적화: 모든 절차를 병렬화**
4. **안전성 최적화: 미리 사인된 업로드 URL**
5. **안전성 최적화: 비디오 보호**


**비용 최적화**

1. 인기 비디오는 CDN을 통해 재생하되 다른 비디오는 비디오 서버를 통해 재생하는 것이다.
2. 인기가 별로 없는 비디오는 인코딩 할 필요가 없을 수도 있다. 짧은 비디오라면 필요할 때 인코딩하여 재생할 수 있다.
3. 어떤 비디오는 특정 지역에서만 인기가 높다. 이런 비디오는 다른 지역에 옮길 필요가 없다.
4. CDN을 직접 구축하고 인터넷 서비스 제공자(ISP, Internet Service Provider)와 제휴한다. CDN을 직접 구축하는 것은 초대형 프로젝트다(대규모 스트리밍 사업자라면 고려해볼 필요가 있을 수 있다). ISP로는 컴캐스트(Comcast), AT&T, 버라이즌(Verizon) 등이 있다. ISP는 전세계 어디나 있으며 사용자와 가깝다. 이들과 제휴하면 사용자 경험을 향상시킬 수 있고 인터넷 사용 비용을 낮출 수 있다.


### 오류 처리

**시스템 오류의 두 가지 종류**  

- 회복 가능 오류(recoverable error)
- 회복 불가능 오류(non-recoverable error)



## Step4. 마무리

설계를 마치고 시간이 좀 남는다면 면접관과 다음과 같은 내용을 논의해도 좋다.

- API 계층의 규모 확장성 확보 방안
- 데이터베이스 계층의 규모 확장성 확보 방안
- 라이브 스트리밍(live streaming)
- 비디오 삭제(takedown)