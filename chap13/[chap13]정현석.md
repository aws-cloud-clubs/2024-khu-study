# #13 검색어 자동완성 시스템

## Step1. 문제 이해 및 설계 범위 확정
- 빠른 응답 속도
- 연관성
- 정렬
- 규모 확장성
- 고가용성

**개략적 규모 추정**

- 일간 능동 사용자(DAU)는 천만 명으로 가정
- 평균적으로 한 사용자는 매일 10건의 검색을 수행한다고 가정
- 질의할 때마다 평균적으로 20바이트의 데이터를 입력한다고 가정
- 검색창에 글자를 입력할 때마다 클라이언트는 검색어 자동완성 백엔드에 요청을 전송. 따라서 평균적으로 1회 검색당 20건의 요청이 백엔드로 전달됨.
- 대략 초당 24000건의 질의(QPS)가 발생( = 10000000사용자 * 10질의 / 일 * 20자 / 24시간 / 3600초)
- 최대 QPS = QPS * 2 = 대략 48000
- 질의 가운데 20% 정도는 신규 검색어라고 가정. 따라서 대략 0.4 GB 정도( = 10000000사용자 * 10질의 / 일 * 20자 * 20%)이며, 매일 0.4 GB의 신규 데이터가 시스템에 추가된다는 뜻

## Step2. 개략적 설게안 제시 및 동의 구하기
개략적으로 보면 시스템은 두 부분으로 나뉜다.

- 데이터 수집 서비스(data gathering service)
    - 사용자가 입력한 질의를 실시간으로 수집하는 시스템
- 질의 서비스(query service)
    - 주어진 질의에 다섯 개의 인기 검색어를 정렬해 놓는 서비스


## Step3. 상세 설계
이번 절에서는 컴포넌트 몇 개를 골라 상세히 설계하고 다음 순서로 최적화 방안을 논의할 것이다.

- 트라이(trie) 자료구조
- 데이터 수집 서비스
- 질의 서비스
- 규모 확장이 가능한 저장소
- 트라이 연산

---

### 트라이 자료구조

**트라이 자료구조의 핵심 아이디어**

- 트라이는 트리 형태의 자료 구조
- 이 트리의 루트 노드는 빈 문자열을 나타냄
- 각 노드는 글자(character) 하나를 저장하며, 26개(해당 글자 다음에 등장할 수 있는 모든 글자의 개수)의 자식 노드를 가질 수 있음
- 각 트리 노드는 하나의 단어, 또는 접두어 문자열(prefix string)을 나타냄

![trie 자료구조](https://github.com/user-attachments/assets/6c37b02f-1d77-4f6a-844d-7c3ca94d4826)

### 데이터 수집 서비스

지금까지 살펴본 설계안은 사용자가 검색창에 뭔가를 타이핑을 할 때마다 실시간으로 데이터를 수정했다. 이 방법은 다음과 같은 두 가지 문제로 실용적이지 않다.

- 매일 수천만 건의 질의가 입력될 텐데 그때마다 트라이를 갱싱하면 질의 서비스는 심각하게 느려짐
- 일단 트라이가 만들어지고 나면 인기 검색어는 그다지 자주 바뀌지 않으므로, 트라이는 자주 갱신할 필요가 없어짐

규모 확장이 쉬운 데이터 수집 서비스를 만들려면 데이터가 어디서 오고 어떻게 이용되는지를 살펴야 한다. 트위터 같은 실시간 어플리케이션이라면 제안되는 검색어를 항상 신선하게 유지할 필요가 있지만 구글 검색 같은 어플리케이션이라면 자주 바꿔줄 이유는 없다.  
용례가 달라지더라도 데이터 수집 서비스의 토대는 바뀌지 않을 것이다. 트라이를 만드는 데 쓰는 데이터는 보통 데이터 분석 서비스(analytics)나 로깅 서비스(logging service)로부터 올 것이기 때문이다.

![데이터 분석 서비스의 수정된 설계안](https://github.com/user-attachments/assets/7396fd3c-f241-4cc1-8953-6f85161b6803)

**데이터 분석 서비스 로그**
- 검색창에 입력된 질의에 관한 원본 데이터가 보관됨

**로그 취합 서버**  
데이터 분석 서비스로부터 나오는 로그의 양은 엄청나고 데이터 형식도 각각 다 다르다. 따라서 이 데이터를 잘 취합하여(aggregation) 우리 시스템이 쉽게 소비할 수 있도록 해야 한다.

**취합된 데이터**

![취합된 데이터 사례](https://github.com/user-attachments/assets/d3d8d528-6c66-44b1-8ee1-6174f7d05910)

time 필드는 해당 주가 시작한 날짜를 나타낸다. frequency 필드는 해당 질의가 해당 주에 사용된 횟수의 합이다.

**작업 서버**
- 주기적으로 비동기적 작업(job)을 실행하는 서버 집합

트라이 자료구조를 만들고 트라이 데이터베이스에 저장하는 역할을 담당한다.

**트라이 캐시**
- 분산 캐시 시스템으로 트라이 데이터를 메모리에 유지하여 읽기 연산 성능을 높이는 역할

매주 트라이 데이터베이스의 스냅샷을 떠서 갱신한다.

**트라이 데이터베이스**

- 지속성 저장소

트라이 데이터베이스로 사용할 수 있는 선택지는 다음과 같은 두 가지가 있다.

1. 문서 저장소(document store)
2. 키-값 저장소

### 질의 서비스

![질의 서비스](https://github.com/user-attachments/assets/bc406a1c-4ac9-416d-b475-01681605a73a)

1. 검색 질의가 로드밸런서로 전송된다.
2. 로드밸런서는 해당 질의를 API 서버로 보낸다.
3. API 서버는 트라이 캐시에서 데이터를 가져와 해당 요청에 대한 자동완성 검색어 제안 응답을 구성한다.
4. 데이터가 트라이 캐시에 없는 경우에는 데이터를 데이터베이스에서 가져와 캐시에 채운다. 그래야 다음에 같은 접두어에 대한 질의가 오면 캐시에 보관된 데이터를 사용해 처리할 수 있다. 캐시 미스(cache miss)는 캐시 서버의 메모리가 부족하거나 캐시 서버에 장애가 있어도 발생할 수 있다.

질의 서비스는 매우 빨라야 한다. 이를 위해 아래와 같은 최적화 방안을 생각해 보기를 제안한다.

- AJAX 요청(request)
- 브라우저 캐싱(browser caching)
- 데이터 샘플링(data sampling)

### 트라이 연산

- 트라이는 검색어 자동완성 시스템의 핵심 컴포넌트

**트라이 생성**

작업 서버가 담당하며, 데이터 분석 서비스의 로그나 데이터베이스로부터 취합된 데이터를 이용한다.

**트라이 갱신**

트라이를 갱신하는 데 아래의 두 가지 방법이 존재한다.

1. 매주 한 번 갱신하는 방법
2. 트라이의 각 노드를 개별적으로 갱신하는 방법

**검색어 삭제**

- 혐오성이 짙거나, 폭력적이거나, 성적으로 노골적이거나, 여러 가지로 위험한 질의어를 자동완성 결과에서 제거해야 함

## Step4. 마무리

상세 설계를 마치고 나면 면접관은 이런 질문들을 던질 수 있다.
- 다국어 지원이 가능하도록 시스템 확장
- 국가별로 인기 검색어가 다르다면?
- 실시간으로 변하는 검색어의 추이를 반영하려면?