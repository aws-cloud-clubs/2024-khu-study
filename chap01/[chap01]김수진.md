# 1️⃣장 사용자 수에 따른 규모 확장성

## 1. 단일 서버

### 사용자 요청 처리 흐름

1. 사용자가 도메인 이름을 이용해 웹사이트에 접속한다.
2. DNS(Domain Name Service)가 Domain 이름을 IP주소로 바꿔준다.
3. 해당 IP 주소로 HTTP 요청이 전달된다.
4. 요청을 받은 웹서버는 HTML 페이지나 JSON 형태의 응답을 반환한다.

## 2. 데이터베이스

사용자가 늘면 서버 하나로는 충분하지 않기 때문에 여러 서버를 둔다.<br>
하나는 **웹/모바일 트래픽 처리** 용도. 하나는 **데이터베이스**용도이다.

> 데이터베이스 종류

1. **관계형 데이터베이스(RDBMS)**

- MySQL, 오라클, PostgreSQL
- 자료를 테이블과 열, 칼럼으로 표현
- SQL을 사용하면 여러 테이블에 있는 데이터를 그 관계에 따라 join해 합칠 수 있다.

2. **비관계형 데이터베이스(NoSQL)**

- CouchDB, Neo4j, Cassandra, HBase, Amazon DynamoDB
- 키-값 저장소, 그래프 저장소, 칼럼 저장소, 문서 저장소로 나뉜다.
- 조인 연산은 지원하지 않는다.
  <br><br>

> **_다음 경우에는 NoSQL이 더 적합하다._**
>
> - 아주 낮은 응답 지연시간이 요구됨
> - 다루는 데이터가 비정형이라 관계형 데이터가 아님
> - 데이터가를 직렬화하거나 역직렬화할 수 있기만 하면 됨
> - 아주 많은 양의 데이터를 저장할 필요가 없음

## 3. 수직적 규모 확장 vs 수직적 규모 확장

### 수직적 규모 확장(Scale Up)

: 서버에 고사양 자원(더 좋은 CPU, 더 많은 RAM 등)을 추가하는 행위

- 서버로 유입되는 **_트래픽의 양이 적을_** 때는 수직적 확장이 더 좋지만, 수직적 규모 확장은 한 대의 서버에 CPU나 메모리를 무한대로 증설할 수는 없다는 한계가 있다.
- 또, 수직적 규모 확장은 장애에 대한 자동복구나 다중화 방안을 제시하지 않는다는 단점이 있다.<br>

### 수평적 규모 확장(Scale Out)

: 더 많은 서버를 추가해 성능을 개선하는 행위 <br>
=> 대규모 애플리케이션을 지원하는 데는 **_수평적 규모 확장_** 이 더 적합하다.

---

### 로드밸런서

: 부하 분산 집합(load balancing set)에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할

- 사용자가 로드밸런서의 public IP 주소로 접속하면, 웹 서버는 클라이언트의 접속을 직접 처리하지 않고, 보안을 위해 Private IP 주소로 서버 간 통신을 한다.
- 장애를 자동복구하지 못하는 문제가 해소되고, 웹 계층의 가용성이 향상된다.
- 서버 1이 다운되면 트래픽을 다 서버 2로 전송할 수 있고, 트래픽이 너무 많이 증가하더라도 로드밸런서가 더 많은 서버를 추가하면 된다.

### 데이터베이스 다중화

: 서버 사이에 주(master)-부(slave) 관계를 설정해 데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식<br><br>
대부분의 애플리케이션은 읽기 연산이 쓰기 연산보다 많이 이루어지기 때문에 부 데이터베이스의 수가 더 많다. <br><br>
**장점**

- 분산되어 병렬적으로 처리되므로 성능이 더 좋다.
- 다중화되어있으므로 일부가 파괴되어도 데이터는 보존된다.(안정성)
- 하나의 데이터베이스 서버에 장애가 발생하더라도 다른 서버에 있는 데이터를 가져오면 된다.(가용성)<br><br>

**주,부 서버**

- 주(master) 서버
  - 쓰기 연산(데이터를 변경하는 명령어들)
- 부(slave) 서버 - 주 서버로부터 사본을 전달받는다. - 읽기 연산
  <br>

**특징**

- 부 서버가 한 대밖에 없는데 다운되면 읽기 연산은 주 서버로 전달된다.
- 주 서버가 다운되면 부 서버가 새로운 주 서버가 된다.

## 4. 응답시간을 개선하는 방법

응답시간을 개선하는 방법에는 캐시를 붙이고, 정적 콘텐츠를 콘텐츠 전송 네트워크(CDN)로 옮기는 방법이 있다.

## 캐시

: 값비싼 연산 결과, 자주 참조되는 데이터를 메모리 안에 두고, 빨리 처리될 수 있도록 하는 저장소

### 캐시 계층

: 데이터가 잠시 보관되는 곳(데이터베이스보다 훨씬 빠름)<br>

**<읽기 주도형 캐시 전략>**<br>
웹 서버는 요청을 받으면 캐시에 저장되어 있는지 보고 있으면 클라이언트에 반환, 없으면 DB에서 꺼내고 캐시에 저장한 뒤 반환한다.<br>

### 캐시 사용 시 유의할 점

- 캐시는 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어날 때 적합하다.
- 영속적인 데이터를 캐시에 두는 것은 바람직하지 않다. 캐시 서버가 재시작되면 모든 데이터는 사라지므로 중요한 데이터는 넣으면 안 된다.
- 만료 정책이 있어야 한다.
  데이터 저장소의 원본과 캐시 내의 사본이 같은지의 여부인 '일관성'이 잘 유지되어야 한다.
- 캐시 서버를 한 대만 두는 경우 해당 서버는 단일 장애 지점(SPOF)이 되어버릴 수 있으므로 캐시 서버를 분산시켜야 한다. (단일 장애 지점 : 어떤 장애가 전체 시스템의 동작을 중단시켜버릴 수 있는 지점)
- 캐시 메모리를 과할당 해야 한다.
- LRU, LFU, FIFO 같은 데이터 방출 정책이 있어야 한다.

## 콘텐츠 전송 네트워크(CDN)

: 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크 (이미지, 비디오 , CSS, JS 파일 등을 캐시할 수 있음)
<br><br>
사용자가 CDN 서버로부터 멀면 멀수록 웹사이트는 천천히 로드된다.

1. 사용자가 이미지 URL을 이용해 image.png에 접근한다
2. CDN 서버의 캐시에 해당 이미지가 없는 경우, 서버는 원본 서버에 요청해 파일을 가져온다.
3. 원본 서버가 파일을 CDN 서버에 반환한다. 응답 헤더에는 해당 파일이 얼마나 오래 캐시될 수 있는지를 설명하는 TTL 값이 들어있다.
4. CDN 서버는 파일을 캐시하고 사용자 A에게 반환한다. (TTL 시간이 끝날 때까지 캐시됨)
5. 다른 사용자가 같은 이미지를 CDN 서버에 요청하면 만료되지 않았다면 캐시를 통해 처리된다.

### CDN 사용 시 고려해야 할 사항

- CDN은 써드파티에 의해 운영되므로 데이터 전송 양에 따라 요금을 내게 되므로 자주 사용되지 않는 콘텐츠를 캐싱하면 안 된다.
- 적절한 만료 시한을 설정해야 한다.
- CDN 장애에 대한 대처 방안이 있어야 한다.
- 아직 만료되지 않은 콘텐츠라 하더라도 무효화할 수 있는 방법이 있다.

## 5. 무상태(stateless) 웹 계층

: 상태 정보를 관계형 데이터베이스나 NoSQL 같은 지속성 저장소에 보관하고 필요할 때 가져오도록 하는 방식<br>

웹 계층을 수평적으로 확장하기 위해선 상태 정보를 웹 계층에서 제거해야 한다.

### 상태 정보 의존적인 아키텍처

같은 클라이언트로부터의 요청은 항상 같은 서버로 전송되어야 해서 로드밸런서는 '고정 세션'기능을 제공하는데, 이는 로드 밸런서에 부담을 준다.

### 무상태 아키텍처

공유 저장소를 사용함으로써 사용자로부터의 HTTP 요청은 어떤 웹 서버로도 전달될 수 있다.

## 6. 데이터 센터

지리적 라우팅 : 가장 가까운 데이터 센터로 안내되는 것
geoDNS : 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 변환할지 결정해주는 서비스

## 7. 메시지 큐

: 메시지의 무손실을 지원하는 컴포넌트(비동기적)
<br>

- 생산자는 소비자 프로세스가 다운되어 있어도 메시지를 발행할 수 있고, 소비자는 생산자 서비스가 가용한 사태가 아니더라도 메시지를 수신할 수 있다.

## 8. 로그, 메트릭 그리고 자동화

로그 : 에러 로그 모니터링 <br>
메트릭 : 메트릭을 잘 수집하면 사업 현황에 관한 유용한 정보를 얻을 수 있다.<br>
자동화 : CI를 도와주는 Tool처럼 자동화 도구를 잘 활용해야 한다.

### 메시지 큐, 로그, 메트릭, 자동화 등을 반영하여 수정한 설계안

## 9. 데이터베이스의 규모 확장

데이터베이스 규모를 확장하는 방법에는 수직적 확장과 수평적 확장 방법이 있다.

1. 수직적 확장
   - 기존 서버에 더 고성능의 자원을 증설하는 방법
   - SPOF 로 인한 위험성이 크다.
   - 비용이 많이 든다.
2. 수평적 확장(샤딩)
   - 더 많은 서버를 추가함으로써 성능을 향상시키는 방법
   - 샤딩 : 대규모 데이터베이스를 샤드라고 부르는 작은 단위로 분할하는 기술 (모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없다.)
     - 샤딩 키(파티션 키)를 잘 정해야 한다.
     - 데이터의 재샤딩 문제
     - 유명인사 문제
     - 조인과 비정규화

## 10. 백만 사용자, 그리고 그 이상

- 웹 계층은 무상태 계층으로 설계
- 모든 계층에 다중화 도입
- 가능한 한 많은 데이터를 캐시할 것
- 여러 데이터센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스할 것
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
- 각 계층은 독립적 서비스로 분할할 것
- 시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것
