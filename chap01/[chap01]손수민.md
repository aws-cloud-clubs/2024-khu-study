# Chap 1. 사용자 수에 따른 규모 확장성

인프라 직군은 수백만 사용자를 지원하고 지속적인 계량과 끝없는 개선이 요구되는 시스템을 설계하는 것이다. 규모 확장성과 관련된 설계 문제에 대해 알아보자.
---
**관계형 데이터베이스**
- MySQL, 오라클 데이터베이스, PostgreSQL 등
- 자료를 테이블과 열, 칼럼으로 표현
- join을 사용하여 다른 테이블의 데이터를 합칠 수 있음

**비 관계형 데이터 베이스**
- CouchDB, Neo4j, HBase, Amazon DynamoDB 등
- 종류
    1. 키-값 저장소
    2. 그래프 저장소
    3. 칼럼 저장소
    4. 문서 저장소
- join 지원 X
- 비 관계형 데이터 베이스를 택할 경우
    - 비정형 데이터
    - 데이터(JSON, YAML, XML 등)를 직렬화하거나 역질렬화 할 수 있을 때
    - 아주 많은 양의 데이터를 저장할 때

**Scale up vs. Scale out**
- scale up: 수직적 규모 확장
    - 고사양 자원을 추가하는 행위
- scale out: 수평적 규모 확장
    - 프로세스를 더 많은 서버를 추가하여 성능 개선
- 수직적 규모 확장에는 한계 존재
- 수직적 규모 확장에는 장애에 대한 자동복구(failover) 방안이나 다중화(re-dundancy) 방안 제시 X. 장애 발생시 서버 다운됨
- → 대규모 애플리케이션을 지원하는 데 수평적 규모 확장법이 보다 적절

**Load Balancing**
- 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할
- 클라이언트는 로드밸런서의 공개 IP로 접속함. 서버 간 통신에는 private IP가 이용되기 때문에 보안 측면에서 이점이 있음.
- 자동복구(failover) 문제를 해결할 수 있고, availability가 향상됨

**데이터베이스 다중화**
- 보통 master-slave 관계로 데이터베이스 관리 시스템을 다중화함. 데이터 원본은 주 서버에, 사본은 부 서버에 저장하여 쓰기 연산(write operation)은 마스터에서만 지원함. 부 데이터베이스에서는 데이터베이스를 변경하는 명령어는 사용할 수 없음(READ ONLY).
- 대부분의 애플리케이션은 읽기 연산의 비중이 쓰기 연산보다 훨씬 높음
- 병렬로 처리될 수 있는 질의(query) 수가 늘어나 성능 향상
- 데이터베이스 서버 일부가 다운되어도 데이터는 보존됨(안전성)
- 데이터베이스 서버에 장애가 발생하더라도 다른 서버에 복제해둔 데이터를 가져와 서비스 가능

**캐시(cache)**
- 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소

**캐시 계층(cache tier)**
- 데이터가 잠시 보관되는 곳으로 데이터베이스보다 훨씬 빠름
- 별도의 캐시 계층을 두면 성능 개선뿐만 아니라 데이터베이스의 부하를 줄일 수 있고, 캐시 계층의 규모를 독립적으로 확장시키는 것도 가능
- 다양한 캐시 전략 존재. e.g., 주도형 캐시 전략(read-though caching strategy)
    - 데이터 종류, 크기, 액세스 패턴에 맞는 캐시 전략 선택
- 캐시는 휘발성임. 지속적 저장소(persistent data store)에 두어야 함
- 만료 정책 설정
- 일관성 유지하기 - Scaling Memcache at Facebook 참고
- 단일 장애 지점 방지
- 캐시 메모리 크기 정하기 - 너무 작으면 eviction, 너무 크면 overprivision
    - 데이터 방출(eviction) 정책
        - LRU 방식으로 사용된 시점이 가장 오래된 데이처를 내보냄
        - LFU: 사용된 빈도가 가장 낮음
        - FIFO 먼저 들어온 데이터 먼저 나가기

**Content Delivery Network (CDN)**
- 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크
- 이미지, 비디오, CSS, JS 파일 등을 캐시할 수 있다.
- 고려해야 할 점
    1. third-party providers에 의해 운영되며, 데이터 전송 양에 따라 요금이 측정된다. → 자주 사용되지 않는 콘텐츠를 캐싱하는 것은 CDN에서 빼자
    2. 적절한 만료 시한 설정
    3. CDN 장애에 대한 대처 방안 - CDN 장애 발생시 원본 서버로부터 직접 콘텐츠를 가져오도록 구성
    4. 콘텐츠 무효화(invalidation): 아직 만료되지 않은 콘텐츠여도 CDN에서 제거
        1. API를 사용해서 무효화
        2. 다른 버전을 서비스하도록 오브젝트 버저닝(object versioning) 이용

**Stateless 웹 계층**
- 웹 계층을 수평적으로 확장
- 상태 정보(사용자 세션 데이터와 같은)를 웹 계층에서 제거
- 상태 정보를 RDS나 NoSQL 같은 지속성 저장소에 보관하고, 필요할 때 가져오도록 구성
- 클라이언트로부터 요청은 항상 같은 서버로 전송되어야 하는 문제가 있음. 로드밸런서가 이를 지원하기 위해 고정 세션(sticky session)이라는 기능 제공하는데, 로드밸런서에게 부하를 줌

**데이터 센터**
- 지리적으로 가까운 센터로 사용자는 안내됨 (geoDNS-routing 또는 geo-routing)이라고 부름
- geoDNS는 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 변환할지 결정할 수 있도록 도와주는 DNS 서비스
- 데이터 센터 중 하나가 장애가 발생하면 다른 데이터 센터로 트래픽이 전송됨
    - 트래픽 우회
    - 데이터 동기화(synchronization): 데이터 센터마다 DB가 다르면 X. 데이터 다중화 필요
    - 테스트와 배포
- 시스템의 컴포넌트를 분리하여, 독립적으로 확장할 수 있도록 할 때 message queue 사용

**Message Queue**
- 무손실(durability)를 보장하는 비동기 통신(asynchronous communication)을 지원하는 컴포넌트
- e.g.,
    - 이미지의 크로핑(cropping), 샤프닝(sharpening), 블러링(blurring) 등을 지원하는 사진 보정 애플리케이션 - 보정은 시간이 오래걸림 → 비동기적으로 처리
    - 보정 작업(worker) 프로세스들은 이 작업을 메시지 큐에서 꺼내어 비동기적으로 완료
    - 큐의 크기가 크면 더 많은 처리, 큐가 항상 비어 있다면 처리기 프로세스 줄이기

**로그, 메트릭, 자동화**
- 메트릭: 시스템의 현재 상태 파악
    - 호스트 단위 메트릭: CPU, Memory, Disk I/O 등
    - 종합(aggregated) 메트릭: 데이터베이스 계층의 성능, 캐시 계층의 성능 등
    - 핵심 비즈니스 메트릭: 일별 능동 사용자(daily active user), 수익(revenue), 재방문(retention) 같은 것들
- 자동화: CI를 도와주는 도구 활용

1. 메시지 큐는 각 컴포넌트가 보다 느슨히 결함(loosely coupled)될 수 있도록 하고, 결함에 대한 내성 높임
2. 로그, 모니터링, 메트릭, 자동화 등을 지원하기 위한 장치 추가
   
**데이터베이스의 규모 확장**
- 수직적 규모 확장
    - 성능 향상 한계 발생
    - SPOF(Single Point of Failure)로 인한 위험성 큼
    - 비용
- 수평적 규모 확장
    - 샤딩: 대규모 데이터베이스를 샤드(shard)라고 부르는 작은 단위로 분할하는 기술
    - 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이 중복 X
    - 샤딩 키(sharding key)를 고려하여 샤딩 전략 구현
    - 샤딩 키는 파티션키(partition key)라고도 부름. 데이터의 분산의 기준을 정하는 하나 이상의 칼럼으로 구성됨
    - 문제
        - 데이터의 재 샤딩(resharding): 샤드 소진(shard exhaustion)시 샤드 키를 계산하는 함수 변경 및 데이터 재배치. 안정 해시(consistent hashing) 기법을 활용하여 해결
        - 유명인사(celebrity) 문제: hotspot key 문제라고도 부르는데 특정 샤드의 과부하. - 저스틴 비버(인스타)
        - join and de-normalization: 데이터베이스를 비정규화하여 하나의 테이블에서 질의가 수행될 수 있도록 함
            - 비정규화: 하나 이상의 테이블에 데이터를 중복해 배치하는 최적화 기법

**수백만 사용자를 고려할 때**
- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 한 많은 데이터를 캐시할 것
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스할 것
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
- 각 계층은 독립적 서비스로 분할할 것
- 시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것